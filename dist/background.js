function createGmailDraft(e){console.log("Creating and sending Gmail draft with data:",e);const t=new Date(e.dateOf6.datetime).toLocaleString();let o;return sendGmailDraft("EnterHospitalEmail@gmail.com","Notification of Euthanasia",`\n    <p style="margin: 0";>Patient: ${e.nameOf}</p>\n    <p style="margin: 0";>Date of Scheduled Appointment: ${t}</p>\n    <p style="margin: 0";>Client Name: ${e.clientName.first} ${e.clientName.last}</p>\n    <p style="margin: 0";>Address: ${e.address.addr_line1}</p>\n    <p style="margin: 0";>         ${e.cityStatePostal}</p>\n    <p style="margin: 0";>Phone Number: ${e.phoneNumber.full}</p>\n\n    <p style="margin: 32px 0";><strong>Petâ€™s ashes and/or memorial products will be delivered to your hospital by West Coast Pet Memorial. Please call the owner when they are ready to be picked-up.</strong></p>\n\n    <p style="margin: 16px 0";>Dear Doctors and Staff,</p>\n\n    <p style="margin: 16px 0";>I regret to inform you of the passing of our mutual patient, ${e.nameOf}, who was humanely euthanized in the comfort of home due to declining quality of life. My condolences for the loss of your patient.<p>\n\n    <p style="margin: 16px 0";>I sincerely appreciate your referral and time. Please do not hesitate to contact me with any questions.</p>\n`,(function(e,t){e?console.error("Failed to create Gmail draft:",e.message):(console.log("%cGmail draft created successfully:","color: green",t),o=t.id)})),e}function sendGmailDraft(e,t,o,n){authenticateGoogle((function(a){if(!a)return console.error("Authentication failed: No token received."),n(new Error("Authentication failed."));const r=["Content-Type: text/html; charset=UTF-8",`To: ${e}`,`Subject: ${t}`,"",o].join("\r\n");makeApiCall("https://gmail.googleapis.com/gmail/v1/users/me/drafts","POST",{message:{raw:btoa(unescape(encodeURIComponent(r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}},a,(function(e,t){if(e)return console.error("Error creating Gmail draft:",e),n(e);console.log("%cDraft created:","color: green",t),n(null,t)}))}))}async function handleData(e){console.log("Step 1: Handle Data");let t=extractFormData(e.content.answers);return t=await gatherAdditionalInformation(t),t.submissionDate=e.content.created_at,console.log("%cSubmission Data Retrieved Successfully:","color: green",t),t}function extractFormData(e){const t={};return Object.values(e).forEach((e=>{e.name&&e.answer&&("string"==typeof e.answer?t[e.name]=e.answer.trim():"object"==typeof e.answer&&null!==e.answer?(Object.entries(e.answer).forEach((([t,o])=>{e.answer[t]=o.trim()})),t[e.name]=e.answer):t[e.name]=e.answer)})),t}async function gatherAdditionalInformation(e){console.log("Step 2: Gather Additional Information");const{species:t,sex:o,address:n}=e;let a,r,i;"Dog"===t?a="pup":"Cat"===t&&(a="kitty"),"Male"===o?(r="him",i="he"):"Female"===o&&(r="her",i="she"),e.cuteSpecies=a,e.pronoun1=r,e.pronoun2=i,console.log(e.address),e.cityStatePostal=`${n.city}, ${n.state} ${n.postal}`,e.cremationType=e.cremationType.includes("PRIVATE cremation")?"Private":e.cremationType.includes("MEMORIAL cremation")?"Memorial":"Retain",e.collectionLocation=e.collectionLocation?e.collectionLocation.includes("office")?"Office":e.collectionLocation.includes("pick-up")?"Pick-up":e.collectionLocation.includes("mailed")?"Mailed":"Sarena":"",e.pawOrNosePrint=e.privatePawOrNosePrint?e.privatePawOrNosePrint:e.memorialPawOrNosePrint;const l=["invoiceTemplateId","letterTemplateId","envelopeTemplateId","euthanasiaPrice","smallPrivateCremationPrice","largePrivateCremationPrice","smallMemorialCremationPrice","largeMemorialCremationPrice","furPrice","furAndBoxPrice","clayPawPrice","clayNosePrice","pawPrintPrice","nosePrintPrice"];return new Promise(((t,o)=>{chrome.storage.local.get(l,(function(n){chrome.runtime.lastError?o(chrome.runtime.lastError):(Object.assign(e,n),console.log("Additional information gathered:",e),t(e))}))}))}async function storeJotformData(e){console.log("Step 3: Store Jotform Data",e);let t=!1,o="",n="",a="",r="";return e.engravingLine1||e.engravingLine2||e.engravingLine3||e.engravingLine4?(t=!0,o=e.engravingLine1,n=e.engravingLine2,a=e.engravingLine3,r=e.engravingLine4):e.metalEngravingLine1||e.metalEngravingLine2?(o=e.metalEngravingLine1,n=e.metalEngravingLine2):(e.namePlateLine1||e.namePlateLine2)&&(o=e.namePlateLine1,n=e.namePlateLine2),e.clayNosePrint||(e.clayNosePrint=0),e.clayPawPrint||(e.clayPawPrint=0),e.additionalBoxedFurClipping||(e.additionalBoxedFurClipping=0),e.additionalFurClipping||(e.additionalFurClipping=0),e.additionalNosePrint||(e.additionalNosePrint=0),e.additonalPawPrint||(e.additonalPawPrint=0),new Promise(((i,l)=>{chrome.storage.local.set({cremationType:e.cremationType,petName:e.nameOf,species:e.species,breed:e.breed,weight:e.approximateWeight,passingDate:e.dateOf6.datetime,sex:e.sex,age:e.age,clientFirstName:e.clientName.first,clientLastName:e.clientName.last,clientEmail:e.email,clientPhone:e.phoneNumber.full,clientAddress1:e.address.addr_line1,clientAddress2:`${e.address.city}, ${e.address.state} ${e.address.postal}`,urnChoice:e.urnChoices,urnLine1:o,urnLine2:n,urnLine3:a,urnLine4:r,isUrnEngraved:t,pawOrNosePrint:e.pawOrNosePrint,clayNosePrint:e.clayNosePrint,clayPawPrint:e.clayPawPrint,additionalBoxedFurClipping:e.additionalBoxedFurClipping,additionalFurClipping:e.additionalFurClipping,additionalNosePrint:e.additionalNosePrint,additonalPawPrint:e.additonalPawPrint,collectionLocation:e.collectionLocation,petHospital:e.petHospital},(function(){chrome.runtime.lastError?l(chrome.runtime.lastError):(console.log("Data saved successfully!"),i(e))}))}))}function createInvoice(e){return new Promise(((t,o)=>{if(console.log("Create Invoice"),"Yes"!==e.itemizedReceipt)return console.log("No itemized Receipt"),t(e);if(!e.invoiceTemplateId)return console.log("Invoice Template ID is missing or empty"),o(new Error("Could not obtain Invoice Template ID. Check settings."));const n=(new Date).toLocaleDateString("en-US");let a=[];a.push({name:"Euthanasia",subtotal:e.euthanasiaPrice}),"Private"===e.cremationType&&e.approximateWeight<80?a.push({name:"Private Cremation (< 80lbs)",subtotal:parseFloat(e.smallPrivateCremationPrice)}):"Private"===e.cremationType&&e.approximateWeight>=80?a.push({name:"Private Cremation (>= 80lbs)",subtotal:parseFloat(e.largePrivateCremationPrice)}):"Memorial"===e.cremationType&&e.approximateWeight<80?a.push({name:"Memorial Cremation (< 80lbs)",subtotal:parseFloat(e.smallPrivateCremationPrice)}):"Memorial"===e.cremationType&&e.approximateWeight>=80&&a.push({name:"Memorial Cremation (>= 80lbs)",subtotal:parseFloat(e.largePrivateCremationPrice)}),e.clayNosePrint&&a.push({name:`Clay Nose Print x${e.clayNosePrint}`,quantity:e.clayNosePrint,subtotal:e.clayNosePrint*parseFloat(e.clayNosePrice)}),e.clayPawPrint&&a.push({name:`Clay Paw Print x${e.clayPawPrint}`,quantity:e.clayPawPrint,subtotal:e.clayPawPrint*parseFloat(e.clayPawPrice)}),e.additionalBoxedFurClipping&&a.push({name:`Additional Boxed Fur Clipping x${e.additionalBoxedFurClipping}`,quantity:e.additionalBoxedFurClipping,subtotal:e.additionalBoxedFurClipping*parseFloat(e.furAndBoxPrice)}),e.additionalFurClipping&&a.push({name:`Additional Fur Clipping x${e.additionalFurClipping}`,quantity:e.additionalFurClipping,subtotal:e.additionalFurClipping*parseFloat(e.furPrice)}),e.additionalNosePrint&&a.push({name:`Additional Nose Print x${e.additionalNosePrint}`,quantity:e.additionalNosePrint,subtotal:e.additionalNosePrint*parseFloat(e.nosePrintPrice)}),e.additonalPawPrint&&a.push({name:`Additional Paw Print x${e.additonalPawPrint}`,quantity:e.additonalPawPrint,subtotal:e.additonalPawPrint*parseFloat(e.pawPrintPrice)}),console.log("Made it 1");const r=a.reduce(((e,t)=>e+(parseFloat(t.subtotal)||0)),0),i=r-0;for(a.forEach((e=>{e.subtotal=formatAsCurrency(e.subtotal)}));a.length<8;)a.push({name:"",subtotal:""});createDocFromTemplate(e.invoiceTemplateId,`(Invoice) ${e.nameOf}'s Passing ${e.submissionDate}`,{Date:n,ClientName:`${e.clientName.first} ${e.clientName.last}`,Address:`${e.address.addr_line1}\n                    ${e.cityStatePostal}`,PhoneNumber:e.phoneNumber.full,PetName:e.nameOf,Breed:e.breed,Age:e.age,Weight:e.approximateWeight,Sex:e.sex,Species:e.species,Product1:a[0].name,Amount1:a[0].subtotal,Product2:a[1].name,Amount2:a[1].subtotal,Product3:a[2].name,Amount3:a[2].subtotal,Product4:a[3].name,Amount4:a[3].subtotal,Product5:a[4].name,Amount5:a[4].subtotal,Product6:a[5].name,Amount6:a[5].subtotal,Product7:a[6].name,Amount7:a[6].subtotal,Product8:a[7].name,Amount8:a[7].subtotal,SubtotalAmt:formatAsCurrency(r),PaidAmt:formatAsCurrency(0),DueAmt:formatAsCurrency(i)}).then((o=>{console.log("%cNew invoice document created with ID:","color: green",o),e.invoiceDocId=o,t(e)})).catch((e=>{console.error("Error in createInvoice:",e),o(e)}))}))}function formatAsCurrency(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e)}function createDocFromTemplate(e,t,o){return new Promise(((n,a)=>{console.log("Starting to copy template..."),copyTemplate(e,t,(function(e,t){if(e)return console.error("Error copying template:",e.message),a(new Error("Error copying template: "+e.message));console.log("Template copied successfully. New Doc ID:",t),console.log("Starting text replacement..."),replaceTextInDocument(t,o,(function(e,o){if(e)return console.error("Error replacing text:",e.message),a(new Error("Error replacing text: "+e.message));console.log("Text replaced successfully in document:",t),n(t)}))}))}))}function copyTemplate(e,t,o){console.log("Copying template with ID:",e,"and Title:",t),authenticateGoogle((function(n){makeApiCall(`https://www.googleapis.com/drive/v3/files/${e}/copy`,"POST",{name:t},n,(function(e,t){if(e)return console.error("Error during template copy:",e.message),o(e);console.log("Template copy succeeded. Response:",t),o(null,t.id)}))}))}function replaceTextInDocument(e,t,o){console.log("Replacing text in document with ID:",e),authenticateGoogle((function(n){makeApiCall(`https://docs.googleapis.com/v1/documents/${e}:batchUpdate`,"POST",{requests:Object.keys(t).map((e=>({replaceAllText:{containsText:{text:`{{${e}}}`,matchCase:!0},replaceText:t[e]}})))},n,(function(e,t){if(e)return console.error("Error during text replacement:",e.message),o(e);console.log("Text replacement succeeded. Response:",t),o(null,t)}))}))}function authenticateGoogle(e){console.log("Starting Google authentication..."),chrome.identity.getAuthToken({interactive:!0},(function(t){if(chrome.runtime.lastError||!t)return console.error("Authentication failed:",chrome.runtime.lastError),e(new Error("Authentication failed."));console.log("Authentication successful. Token received:",t),e(t)}))}function makeApiCall(e,t,o,n,a){console.log("Making API call to:",e,"with data:",o),fetch(e,{method:t,headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:o?JSON.stringify(o):null}).then((e=>e.ok?e.json():e.json().then((t=>{throw console.error("API call failed:",t),new Error(`API call failed with status ${e.status}: ${t.error.message}`)})))).then((e=>{console.log("API call succeeded with data:",e),a(null,e)})).catch((e=>{console.error("API call error:",e.message),a(e)}))}async function createLetter(e){if(console.log("Starting createLetter function"),!e.letterTemplateId)throw console.error("Letter Template ID is missing or empty"),new Error("Could not obtain Letter Template ID. Check settings.");console.log("Letter Template ID:",e.letterTemplateId);try{console.log("Calling createDocFromTemplate...");const t=await createDocFromTemplate(e.letterTemplateId,`(Letter) ${e.nameOf}'s Passing ${e.submissionDate}`,{familyName:e.clientName.last,NameOfPet:e.nameOf,species:e.cuteSpecies,pronoun1:e.pronoun1,pronoun2:e.pronoun2});return console.log("createDocFromTemplate succeeded, new document ID:",t),e.letterDocId=t,console.log("Letter document ID saved in data:",e.letterDocId),e}catch(e){throw console.error("Error in createLetter:",e),e}}function createEnvelope(e){return new Promise(((t,o)=>{if(console.log("Create Envelope"),!e.envelopeTemplateId)return console.log("Envelope Template ID is missing or empty"),o(new Error("Could not obtain Envelope Template ID. Check settings."));createDocFromTemplate(e.envelopeTemplateId,`(Envelope) ${e.nameOf}'s Passing ${e.submissionDate}`,{familyName:e.clientName.last,AddressLine1:e.address.addr_line1,AddressLine2:e.cityStatePostal,AddressLine3:""}).then((o=>{console.log("%cNew envelope document created with ID:","color: green",o),e.envelopeDocId=o,t(e)})).catch((e=>{console.error("Error in createEnvelope:",e),o(e)}))}))}chrome.tabs.onUpdated.addListener(((e,t,o)=>{chrome.storage.local.get(["jotformFormId"],(function(n){const a=n.jotformFormId;console.log("%cRetrieved JotForm form ID: ","color: green;",a),"complete"===t.status&&o.url&&o.url.includes(`jotform.com/inbox/${a}`)?chrome.tabs.sendMessage(e,{action:"createFormButton",type:"NEW"}):"complete"===t.status&&o.url&&o.url.includes("pawsetrack.vet/app/dashboard")?chrome.tabs.sendMessage(e,{action:"startNewOrder",type:"NEW"}):"complete"===t.status&&o.url&&o.url.includes("pawsetrack.vet/app/orders/start")?chrome.tabs.sendMessage(e,{action:"selectCremationType",type:"NEW"}):"complete"===t.status&&o.url&&o.url.includes("pawsetrack.vet/app/orders/add")?o.url.includes("(details:petandowner)")?chrome.tabs.sendMessage(e,{action:"fillPetAndOwnerForm",type:"NEW"}):o.url.includes("(details:bundles)")?chrome.tabs.sendMessage(e,{action:"fillBundlesForm",type:"NEW"}):o.url.includes("(details:urn)")?chrome.tabs.sendMessage(e,{action:"selectUrn",type:"NEW"}):o.url.includes("(details:memorial)")?chrome.tabs.sendMessage(e,{action:"fillMemorialForm",type:"NEW"}):o.url.includes("(details:review)")&&chrome.tabs.sendMessage(e,{action:"fillReviewForm",type:"NEW"}):"complete"===t.status&&o.url&&o.url.includes("eventedit")&&chrome.tabs.sendMessage(e,{action:"createJotformLinkButton",type:"NEW"})}))})),chrome.runtime.onMessage.addListener(((e,t,o)=>{if("fillDocsAndEmail"===e.action){const t=e.submissionId;return chrome.storage.local.get(["jotformToken"],(function(e){const n=e.jotformToken;n||o({success:!1,error:"Could not obtain Jotform API key. Check settings."}),console.log("%cRetrieved JotForm token: ","color: green",n),fetch(`https://api.jotform.com/submission/${t}?apiKey=${n}`).then((e=>e.json())).then(handleData).then(storeJotformData).then(createGmailDraft).then(createInvoice).then(createLetter).then(createEnvelope).then((e=>{console.log("All tasks completed successfully with data:",e),o({success:!0,data:e})})).catch((e=>{console.error("Error during data processing:",e),o({success:!1,error:e.message})}))})),!0}if("fillCrematoryForms"===e.action){const t=e.submissionId;return chrome.storage.local.get(["jotformToken"],(function(e){const n=e.jotformToken;console.log("%cRetrieved JotForm token: ","color: green",n),fetch(`https://api.jotform.com/submission/${t}?apiKey=${n}`).then((e=>e.json())).then(handleData).then(storeJotformData).then((e=>{console.log("All tasks completed successfully with data:",e),o({success:!0,data:e})})).catch((e=>{console.error("Error during data processing:",e),o({success:!1,error:e.message})}))})),!0}if("openAndPrintDoc"===e.action){const t=`https://docs.google.com/document/d/${e.docId}/edit`;chrome.tabs.create({url:t},(function(t){chrome.tabs.onUpdated.addListener((function o(n,a){n===t.id&&"complete"===a.status&&(chrome.tabs.sendMessage(n,{action:"printDoc",docId:e.docId}),chrome.tabs.onUpdated.removeListener(o))}))}))}else"deleteDoc"===e.action&&deleteDocument(e.docId)}));